version: "2"

build:
  builder: dockerfile
  dockerfile: Dockerfile

deploy:
  restartPolicyType: always
  healthcheckPath: /health
  healthcheckTimeout: 300

services:
  - name: api
    source: .
    dockerfile: ./api/Dockerfile
    variables:
      - name: MODE
        value: api
      - name: SECRET_KEY
        value: ${{ secrets.SECRET_KEY }}
      - name: DATABASE_URL
        value: ${{ Railway.DATABASE_URL }}
      - name: REDIS_URL  
        value: ${{ Railway.REDIS_URL }}
      - name: VECTOR_STORE
        value: qdrant
      - name: QDRANT_URL
        value: ${{ Railway.QDRANT_URL }}
    healthcheckPath: /health
    
  - name: web
    source: ./web
    dockerfile: ./web/Dockerfile
    variables:
      - name: NEXT_PUBLIC_API_PREFIX
        value: https://${{ Railway.api.domain }}/v1
      - name: NEXT_PUBLIC_PUBLIC_API_PREFIX  
        value: https://${{ Railway.api.domain }}/v1
    healthcheckPath: /
    
  - name: worker
    source: .
    dockerfile: ./api/Dockerfile
    variables:
      - name: MODE
        value: worker
      - name: SECRET_KEY
        value: ${{ secrets.SECRET_KEY }}
      - name: DATABASE_URL
        value: ${{ Railway.DATABASE_URL }}
      - name: REDIS_URL
        value: ${{ Railway.REDIS_URL }}
      - name: VECTOR_STORE
        value: qdrant
      - name: QDRANT_URL
        value: ${{ Railway.QDRANT_URL }}

databases:
  - type: postgresql
    name: postgres
    
  - type: redis
    name: redis
