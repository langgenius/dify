name: Web Tests

on:
  workflow_call:

concurrency:
  group: web-tests-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  test:
    name: Web Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
        working-directory: ./web

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Check changed files
        id: changed-files
        uses: tj-actions/changed-files@v46
        with:
          files: web/**

      - name: Install pnpm
        if: steps.changed-files.outputs.any_changed == 'true'
        uses: pnpm/action-setup@v4
        with:
          package_json_file: web/package.json
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        if: steps.changed-files.outputs.any_changed == 'true'
        with:
          node-version: 22
          cache: pnpm
          cache-dependency-path: ./web/pnpm-lock.yaml

      - name: Install dependencies
        if: steps.changed-files.outputs.any_changed == 'true'
        working-directory: ./web
        run: pnpm install --frozen-lockfile

      - name: Check i18n types synchronization
        if: steps.changed-files.outputs.any_changed == 'true'
        working-directory: ./web
        run: pnpm run check:i18n-types

      - name: Run tests
        if: steps.changed-files.outputs.any_changed == 'true'
        working-directory: ./web
        run: pnpm test -- --coverage

      - name: Coverage Summary
        if: steps.changed-files.outputs.any_changed == 'true'
        id: coverage-summary
        working-directory: ./web
        run: |
          set -eo pipefail

          COVERAGE_FILE="coverage/coverage-final.json"

          if [ ! -f "$COVERAGE_FILE" ]; then
            echo "has_coverage=false" >> "$GITHUB_OUTPUT"
            echo "### ðŸš¨ Test Coverage Report :test_tube:" >> "$GITHUB_STEP_SUMMARY"
            echo "Coverage data not found at $COVERAGE_FILE. Ensure Jest runs with coverage enabled." >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          echo "has_coverage=true" >> "$GITHUB_OUTPUT"

          node <<'NODE' >> "$GITHUB_STEP_SUMMARY"
          const fs = require('fs');
          const path = require('path');
          const { createCoverageMap } = require('istanbul-lib-coverage');

          const coveragePath = path.join('coverage', 'coverage-final.json');
          const raw = fs.readFileSync(coveragePath, 'utf8');
          const map = createCoverageMap(JSON.parse(raw));
          const summary = map.getCoverageSummary();

          const metrics = [
            { key: 'lines', label: 'Lines' },
            { key: 'statements', label: 'Statements' },
            { key: 'branches', label: 'Branches' },
            { key: 'functions', label: 'Functions' },
          ];

          const formatPct = (pct) => Number.isFinite(pct) ? pct.toFixed(2) : '0.00';

          console.log('### Test Coverage Summary :test_tube:');
          console.log('');
          console.log('| Metric | Coverage | Covered / Total |');
          console.log('|--------|----------|-----------------|');
          metrics.forEach(({ key, label }) => {
            const data = summary.data[key];
            console.log(`| ${label} | ${formatPct(data.pct)}% | ${data.covered} / ${data.total} |`);
          });

          const fileSummaries = map.files().map((file) => {
            const lines = map.fileCoverageFor(file).toSummary().data.lines;
            return {
              file,
              pct: lines.pct,
              covered: lines.covered,
              total: lines.total,
            };
          });

          console.log('');
          console.log('<details><summary>File coverage (lowest lines first)</summary>');
          console.log('');
          console.log('```');
          fileSummaries
            .sort((a, b) => (a.pct - b.pct) || (b.total - a.total))
            .slice(0, 25)
            .forEach(({ file, pct, covered, total }) => {
              console.log(`${formatPct(pct)}%\t${covered}/${total}\t${file}`);
            });
          console.log('```');
          console.log('</details>');
          NODE

      - name: Upload Coverage Artifact
        if: steps.changed-files.outputs.any_changed == 'true' && steps.coverage-summary.outputs.has_coverage == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: web-coverage-report
          path: web/coverage
          retention-days: 30
          if-no-files-found: error
