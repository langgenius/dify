name: Web Tests

on:
  workflow_call:

concurrency:
  group: web-tests-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  test:
    name: Web Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
        working-directory: ./web

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Check changed files
        id: changed-files
        uses: tj-actions/changed-files@v46
        with:
          files: web/**

      - name: Install pnpm
        if: steps.changed-files.outputs.any_changed == 'true'
        uses: pnpm/action-setup@v4
        with:
          package_json_file: web/package.json
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        if: steps.changed-files.outputs.any_changed == 'true'
        with:
          node-version: 22
          cache: pnpm
          cache-dependency-path: ./web/pnpm-lock.yaml

      - name: Install dependencies
        if: steps.changed-files.outputs.any_changed == 'true'
        working-directory: ./web
        run: pnpm install --frozen-lockfile

      - name: Check i18n types synchronization
        if: steps.changed-files.outputs.any_changed == 'true'
        working-directory: ./web
        run: pnpm run check:i18n-types

      - name: Run tests
        if: steps.changed-files.outputs.any_changed == 'true'
        working-directory: ./web
        run: pnpm exec jest --coverage --passWithNoTests

      - name: Coverage Summary
        if: steps.changed-files.outputs.any_changed == 'true'
        id: coverage-summary
        working-directory: ./web
        run: |
          set -eo pipefail

          COVERAGE_FILE="coverage/coverage-final.json"

          if [ ! -f "$COVERAGE_FILE" ]; then
            echo "has_coverage=false" >> "$GITHUB_OUTPUT"
            echo "### ðŸš¨ Test Coverage Report :test_tube:" >> "$GITHUB_STEP_SUMMARY"
            echo "Coverage data not found at $COVERAGE_FILE. Ensure Jest runs with coverage enabled." >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          echo "has_coverage=true" >> "$GITHUB_OUTPUT"

          node <<'NODE' >> "$GITHUB_STEP_SUMMARY"
          const fs = require('fs');
          const path = require('path');

          const coveragePath = path.join('coverage', 'coverage-final.json');
          const coverage = JSON.parse(fs.readFileSync(coveragePath, 'utf8'));

          const total = {
            lines: { covered: 0, total: 0 },
            statements: { covered: 0, total: 0 },
            branches: { covered: 0, total: 0 },
            functions: { covered: 0, total: 0 },
          };

          const fileSummaries = Object.entries(coverage).map(([file, entry]) => {
            const lineHits = entry.l ?? {};
            const statementHits = entry.s ?? {};
            const branchHits = entry.b ?? {};
            const functionHits = entry.f ?? {};

            const lineTotal = Object.keys(lineHits).length;
            const lineCovered = Object.values(lineHits).filter((n) => n > 0).length;

            const statementTotal = Object.keys(statementHits).length;
            const statementCovered = Object.values(statementHits).filter((n) => n > 0).length;

            const branchTotal = Object.values(branchHits).reduce((acc, branches) => acc + branches.length, 0);
            const branchCovered = Object.values(branchHits).reduce(
              (acc, branches) => acc + branches.filter((n) => n > 0).length,
              0,
            );

            const functionTotal = Object.keys(functionHits).length;
            const functionCovered = Object.values(functionHits).filter((n) => n > 0).length;

            total.lines.total += lineTotal;
            total.lines.covered += lineCovered;
            total.statements.total += statementTotal;
            total.statements.covered += statementCovered;
            total.branches.total += branchTotal;
            total.branches.covered += branchCovered;
            total.functions.total += functionTotal;
            total.functions.covered += functionCovered;

            const pct = (covered, tot) => (tot > 0 ? (covered / tot) * 100 : 0);

            return {
              file,
              pct: pct(lineCovered || statementCovered, lineTotal || statementTotal),
              lines: { covered: lineCovered, total: lineTotal },
            };
          });

          const pct = (covered, tot) => (tot > 0 ? ((covered / tot) * 100).toFixed(2) : '0.00');

          console.log('### Test Coverage Summary :test_tube:');
          console.log('');
          console.log('| Metric | Coverage | Covered / Total |');
          console.log('|--------|----------|-----------------|');
          console.log(`| Lines | ${pct(total.lines.covered, total.lines.total)}% | ${total.lines.covered} / ${total.lines.total} |`);
          console.log(`| Statements | ${pct(total.statements.covered, total.statements.total)}% | ${total.statements.covered} / ${total.statements.total} |`);
          console.log(`| Branches | ${pct(total.branches.covered, total.branches.total)}% | ${total.branches.covered} / ${total.branches.total} |`);
          console.log(`| Functions | ${pct(total.functions.covered, total.functions.total)}% | ${total.functions.covered} / ${total.functions.total} |`);

          console.log('');
          console.log('<details><summary>File coverage (lowest lines first)</summary>');
          console.log('');
          console.log('```');
          fileSummaries
            .sort((a, b) => (a.pct - b.pct) || (b.lines.total - a.lines.total))
            .slice(0, 25)
            .forEach(({ file, pct, lines }) => {
              console.log(`${pct.toFixed(2)}%\t${lines.covered}/${lines.total}\t${file}`);
            });
          console.log('```');
          console.log('</details>');
          NODE

      - name: Upload Coverage Artifact
        if: steps.changed-files.outputs.any_changed == 'true' && steps.coverage-summary.outputs.has_coverage == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: web-coverage-report
          path: web/coverage
          retention-days: 30
          if-no-files-found: error
