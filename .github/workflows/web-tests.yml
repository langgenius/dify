name: Web Tests

on:
  workflow_call:

concurrency:
  group: web-tests-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  test:
    name: Web Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./web

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Check changed files
        id: changed-files
        uses: tj-actions/changed-files@v46
        with:
          files: web/**

      - name: Install pnpm
        if: steps.changed-files.outputs.any_changed == 'true'
        uses: pnpm/action-setup@v4
        with:
          package_json_file: web/package.json
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        if: steps.changed-files.outputs.any_changed == 'true'
        with:
          node-version: 22
          cache: pnpm
          cache-dependency-path: ./web/package.json

      - name: Install dependencies
        if: steps.changed-files.outputs.any_changed == 'true'
        working-directory: ./web
        run: pnpm install --frozen-lockfile

      - name: Check i18n types synchronization
        if: steps.changed-files.outputs.any_changed == 'true'
        working-directory: ./web
        run: pnpm run check:i18n-types

      - name: Run tests
        if: steps.changed-files.outputs.any_changed == 'true'
        working-directory: ./web
        run: pnpm test -- --coverage

      - name: Coverage Summary
        if: steps.changed-files.outputs.any_changed == 'true'
        working-directory: ./web
        run: |
          set -x

          # Check if coverage files exist
          if [ ! -f "coverage/coverage-final.json" ]; then
            echo "### ðŸš¨ Test Coverage Report :test_tube:" >> $GITHUB_STEP_SUMMARY
            echo "No coverage data found. Make sure tests generate coverage reports." >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          # Extract coverage percentages by calculating from all files
          LINES_COVERAGE=$(node -e "
            const coverage = JSON.parse(require('fs').readFileSync('coverage/coverage-final.json', 'utf8'));
            let totalLines = 0;
            let coveredLines = 0;
            Object.values(coverage).forEach(file => {
              if (file.s) {
                Object.values(file.s).forEach(count => {
                  totalLines += 1;
                  if (count > 0) coveredLines += 1;
                });
              }
            });
            const pct = totalLines > 0 ? ((coveredLines / totalLines) * 100).toFixed(2) : '0.00';
            console.log(pct);
          ")

          FUNCTIONS_COVERAGE=$(node -e "
            const coverage = JSON.parse(require('fs').readFileSync('coverage/coverage-final.json', 'utf8'));
            let totalFunctions = 0;
            let coveredFunctions = 0;
            Object.values(coverage).forEach(file => {
              if (file.f) {
                Object.values(file.f).forEach(count => {
                  totalFunctions += 1;
                  if (count > 0) coveredFunctions += 1;
                });
              }
            });
            const pct = totalFunctions > 0 ? ((coveredFunctions / totalFunctions) * 100).toFixed(2) : '0.00';
            console.log(pct);
          ")

          BRANCHES_COVERAGE=$(node -e "
            const coverage = JSON.parse(require('fs').readFileSync('coverage/coverage-final.json', 'utf8'));
            let totalBranches = 0;
            let coveredBranches = 0;
            Object.values(coverage).forEach(file => {
              if (file.b) {
                Object.values(file.b).forEach(branches => {
                  totalBranches += 1;
                  if (branches.some(b => b > 0)) coveredBranches += 1;
                });
              }
            });
            const pct = totalBranches > 0 ? ((coveredBranches / totalBranches) * 100).toFixed(2) : '0.00';
            console.log(pct);
          ")

          STATEMENTS_COVERAGE=$LINES_COVERAGE  # Lines and statements are the same in coverage-final.json

          # Create a detailed coverage summary
          echo "### ðŸ“Š Test Coverage Report :test_tube:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Coverage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|----------|--------|" >> $GITHUB_STEP_SUMMARY

          # Function to determine status emoji and color
          get_status() {
            local coverage=$1
            if (( $(echo "$coverage >= 80" | bc -l) )); then
              echo "âœ…"
            elif (( $(echo "$coverage >= 60" | bc -l) )); then
              echo "âš ï¸"
            else
              echo "âŒ"
            fi
          }

          LINES_STATUS=$(get_status $LINES_COVERAGE)
          FUNCTIONS_STATUS=$(get_status $FUNCTIONS_COVERAGE)
          BRANCHES_STATUS=$(get_status $BRANCHES_COVERAGE)
          STATEMENTS_STATUS=$(get_status $STATEMENTS_COVERAGE)

          echo "| Lines | ${LINES_COVERAGE}% | $LINES_STATUS |" >> $GITHUB_STEP_SUMMARY
          echo "| Functions | ${FUNCTIONS_COVERAGE}% | $FUNCTIONS_STATUS |" >> $GITHUB_STEP_SUMMARY
          echo "| Branches | ${BRANCHES_COVERAGE}% | $BRANCHES_STATUS |" >> $GITHUB_STEP_SUMMARY
          echo "| Statements | ${STATEMENTS_COVERAGE}% | $STATEMENTS_STATUS |" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY

          # Coverage thresholds
          if (( $(echo "$LINES_COVERAGE >= 80 && $FUNCTIONS_COVERAGE >= 80 && $BRANCHES_COVERAGE >= 80 && $STATEMENTS_COVERAGE >= 80" | bc -l) )); then
            echo "ðŸŽ‰ **Excellent coverage! All metrics above 80%**" >> $GITHUB_STEP_SUMMARY
          elif (( $(echo "$LINES_COVERAGE >= 60 && $FUNCTIONS_COVERAGE >= 60 && $BRANCHES_COVERAGE >= 60 && $STATEMENTS_COVERAGE >= 60" | bc -l) )); then
            echo "ðŸ‘ **Good coverage! All metrics above 60%**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Coverage needs improvement. Consider adding more tests.**" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          {
            echo "<details><summary>ðŸ“‹ Detailed coverage report (click to expand)</summary>"
            echo ""
            echo '```'
            node -e "
              const coverage = JSON.parse(require('fs').readFileSync('coverage/coverage-final.json', 'utf8'));
              let totalLines = 0, coveredLines = 0;
              let totalFunctions = 0, coveredFunctions = 0;
              let totalBranches = 0, coveredBranches = 0;

              Object.values(coverage).forEach(file => {
                if (file.s) {
                  Object.values(file.s).forEach(count => {
                    totalLines += 1;
                    if (count > 0) coveredLines += 1;
                  });
                }
                if (file.f) {
                  Object.values(file.f).forEach(count => {
                    totalFunctions += 1;
                    if (count > 0) coveredFunctions += 1;
                  });
                }
                if (file.b) {
                  Object.values(file.b).forEach(branches => {
                    totalBranches += 1;
                    if (branches.some(b => b > 0)) coveredBranches += 1;
                  });
                }
              });

              console.log('Overall Coverage:');
              console.log(\`  Lines: \${((coveredLines/totalLines)*100).toFixed(2)}% (\${coveredLines}/\${totalLines})\`);
              console.log(\`  Functions: \${((coveredFunctions/totalFunctions)*100).toFixed(2)}% (\${coveredFunctions}/\${totalFunctions})\`);
              console.log(\`  Branches: \${((coveredBranches/totalBranches)*100).toFixed(2)}% (\${coveredBranches}/\${totalBranches})\`);
              console.log(\`  Statements: \${((coveredLines/totalLines)*100).toFixed(2)}% (\${coveredLines}/\${totalLines})\`);
            "
            echo '```'
            echo "</details>"
          } >> $GITHUB_STEP_SUMMARY

          # Upload coverage artifact for potential download
          if [ -d "coverage" ]; then
            echo "Uploading coverage reports as artifact..."
            tar -czf coverage-report.tar.gz coverage/
          fi

      - name: Upload Coverage Artifact
        if: steps.changed-files.outputs.any_changed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: web-coverage-report
          path: web/coverage-report.tar.gz
          retention-days: 30
