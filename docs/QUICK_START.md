# å¿«é€Ÿå¼€å§‹æŒ‡å—

## ğŸ‰ åˆ†æ”¯ç®¡ç†ç­–ç•¥å·²é…ç½®å®Œæˆ

ä½ çš„ä»“åº“ç°åœ¨å·²ç»é…ç½®äº†å®Œæ•´çš„å›¢é˜Ÿåä½œåˆ†æ”¯ç®¡ç†ç­–ç•¥ï¼

## âœ… å·²å®Œæˆçš„é…ç½®

### 1. åˆ†æ”¯ç»“æ„
- âœ… `dev` - ä¸»å¼€å‘åˆ†æ”¯ï¼ˆå·²æ¨é€åˆ°è¿œç¨‹ï¼‰
- âœ… `upstream-1.11.4` - ä¸Šæ¸¸ç‰ˆæœ¬è¿½è¸ªåˆ†æ”¯ï¼ˆå·²æ¨é€åˆ°è¿œç¨‹ï¼‰
- âœ… åˆ é™¤ä¸´æ—¶åˆ†æ”¯ `v1.11.4`

### 2. æœ¬åœ°ä¿æŠ¤ï¼ˆGit Hooksï¼‰
- âœ… `pre-commit` hook - é˜»æ­¢ç›´æ¥æäº¤åˆ°å—ä¿æŠ¤åˆ†æ”¯
- âœ… `pre-push` hook - é˜»æ­¢ç›´æ¥æ¨é€åˆ°å—ä¿æŠ¤åˆ†æ”¯
- âœ… æµ‹è¯•é€šè¿‡ - hooks æ­£å¸¸å·¥ä½œ

### 3. æ–‡æ¡£
- âœ… `.github/BRANCH_PROTECTION_GUIDE.md` - GitHub åˆ†æ”¯ä¿æŠ¤é…ç½®æŒ‡å—
- âœ… `docs/TEAM_WORKFLOW.md` - å®Œæ•´çš„å›¢é˜Ÿåä½œå·¥ä½œæµç¨‹æ–‡æ¡£
- âœ… `scripts/setup-git-hooks.sh` - å›¢é˜Ÿæˆå‘˜å¿«é€Ÿè®¾ç½®è„šæœ¬

## ğŸš€ æ¥ä¸‹æ¥éœ€è¦åšä»€ä¹ˆ

### æ­¥éª¤ 1: é…ç½® GitHub åˆ†æ”¯ä¿æŠ¤è§„åˆ™ï¼ˆé‡è¦ï¼‰

**æœ¬åœ° Git hooks åªèƒ½ä¿æŠ¤ä½ è‡ªå·±çš„æœ¬åœ°ä»“åº“ï¼Œä¸èƒ½ä¿æŠ¤è¿œç¨‹ä»“åº“ã€‚**

è¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤åœ¨ GitHub ä¸Šé…ç½®åˆ†æ”¯ä¿æŠ¤ï¼š

1. è®¿é—®ä»“åº“è®¾ç½®ï¼šhttps://github.com/xianglixiang/dify/settings/branches

2. ä¸º `dev` åˆ†æ”¯æ·»åŠ ä¿æŠ¤è§„åˆ™ï¼š
   - Branch name pattern: `dev`
   - âœ… Require a pull request before merging
   - âœ… Require approvals: 1+
   - âœ… Dismiss stale pull request approvals when new commits are pushed
   - âœ… Require status checks to pass (å¦‚æœé…ç½®äº† CI)
   - âœ… Require conversation resolution before merging
   - âœ… Include administrators

3. ä¸º `upstream-*` åˆ†æ”¯æ·»åŠ ä¿æŠ¤è§„åˆ™ï¼š
   - Branch name pattern: `upstream-*`
   - âœ… Lock branch (åªè¯»)
   - âœ… Restrict who can push (ä»…ç®¡ç†å‘˜)

è¯¦ç»†é…ç½®è¯´æ˜è¯·æŸ¥çœ‹ï¼š`.github/BRANCH_PROTECTION_GUIDE.md`

### æ­¥éª¤ 2: é€šçŸ¥å›¢é˜Ÿæˆå‘˜

å‘é€ä»¥ä¸‹ä¿¡æ¯ç»™å›¢é˜Ÿæˆå‘˜ï¼š

```
ğŸ“¢ ä»“åº“åˆ†æ”¯ç®¡ç†ç­–ç•¥æ›´æ–°

æˆ‘ä»¬å·²ç»é…ç½®äº†æ–°çš„åˆ†æ”¯ç®¡ç†ç­–ç•¥ï¼Œè¯·æ‰€æœ‰å›¢é˜Ÿæˆå‘˜ï¼š

1. æ‹‰å–æœ€æ–°ä»£ç ï¼š
   cd dify
   git fetch origin
   git checkout dev
   git pull origin dev

2. è®¾ç½® Git hooksï¼š
   ./scripts/setup-git-hooks.sh

3. é˜…è¯»å·¥ä½œæµç¨‹æ–‡æ¡£ï¼š
   docs/TEAM_WORKFLOW.md

4. å¼€å§‹ä½¿ç”¨æ–°çš„å·¥ä½œæµï¼š
   git checkout -b feature/your-feature-name

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹æ–‡æ¡£æˆ–è”ç³»ç®¡ç†å‘˜ã€‚
```

### æ­¥éª¤ 3: é…ç½® CI/CDï¼ˆæ¨èï¼‰

å»ºè®®é…ç½® GitHub Actions æ¥è‡ªåŠ¨è¿è¡Œæµ‹è¯•å’Œæ£€æŸ¥ï¼š

1. åˆ›å»º `.github/workflows/pr-checks.yml`
2. é…ç½®ä»¥ä¸‹æ£€æŸ¥ï¼š
   - Backend: `make lint`, `make type-check`, pytest
   - Frontend: `pnpm lint:fix`, `pnpm type-check:tsgo`, `pnpm test`
3. åœ¨åˆ†æ”¯ä¿æŠ¤è§„åˆ™ä¸­è¦æ±‚è¿™äº›æ£€æŸ¥é€šè¿‡

å‚è€ƒï¼šç°æœ‰çš„ `.github/workflows/` ç›®å½•ä¸­çš„å·¥ä½œæµ

### æ­¥éª¤ 4: å¼€å§‹ä½¿ç”¨æ–°å·¥ä½œæµ

ä»ç°åœ¨å¼€å§‹ï¼Œæ‰€æœ‰å¼€å‘éƒ½åº”è¯¥ï¼š

```bash
# 1. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯
git checkout dev
git pull origin dev
git checkout -b feature/your-feature-name

# 2. å¼€å‘å’Œæäº¤
git add .
git commit -m "feat: your feature description"

# 3. æ¨é€
git push origin feature/your-feature-name

# 4. åœ¨ GitHub ä¸Šåˆ›å»º PR
# 5. ç­‰å¾…å®¡æŸ¥å’Œåˆå¹¶
```

## ğŸ“š é‡è¦æ–‡æ¡£

| æ–‡æ¡£ | ç”¨é€” |
|------|------|
| `docs/TEAM_WORKFLOW.md` | **å¿…è¯»** - å®Œæ•´çš„å›¢é˜Ÿåä½œå·¥ä½œæµç¨‹ |
| `.github/BRANCH_PROTECTION_GUIDE.md` | GitHub åˆ†æ”¯ä¿æŠ¤é…ç½®è¯¦ç»†æŒ‡å— |
| `scripts/setup-git-hooks.sh` | å›¢é˜Ÿæˆå‘˜å¿«é€Ÿè®¾ç½® Git hooks |
| `.github/pull_request_template.md` | PR æ¨¡æ¿ï¼ˆå·²å­˜åœ¨ï¼‰ |

## ğŸ§ª æµ‹è¯•éªŒè¯

### éªŒè¯æœ¬åœ°ä¿æŠ¤

```bash
# åº”è¯¥è¢«é˜»æ­¢
git checkout dev
git commit --allow-empty -m "test"

# åº”è¯¥æˆåŠŸ
git checkout -b feature/test
git commit --allow-empty -m "test"
```

### éªŒè¯è¿œç¨‹ä¿æŠ¤ï¼ˆé…ç½® GitHub åï¼‰

1. å°è¯•ç›´æ¥æ¨é€åˆ° devï¼šåº”è¯¥è¢«æ‹’ç»
2. åˆ›å»º PR ä¸è¯·æ±‚å®¡æŸ¥å°±åˆå¹¶ï¼šåº”è¯¥è¢«æ‹’ç»
3. é€šè¿‡æ­£å¸¸ PR æµç¨‹ï¼šåº”è¯¥æˆåŠŸ

## âš ï¸ é‡è¦æ³¨æ„äº‹é¡¹

### å½“å‰çŠ¶æ€
- âœ… æœ¬åœ°ä¿æŠ¤å·²æ¿€æ´»ï¼ˆGit hooksï¼‰
- âš ï¸ è¿œç¨‹ä¿æŠ¤æœªæ¿€æ´»ï¼ˆéœ€è¦åœ¨ GitHub ä¸Šé…ç½®ï¼‰

### åœ¨é…ç½® GitHub åˆ†æ”¯ä¿æŠ¤ä¹‹å‰
ä»»ä½•äººéƒ½å¯ä»¥ç›´æ¥æ¨é€åˆ° `dev` åˆ†æ”¯ï¼ˆå¦‚æœç»•è¿‡æœ¬åœ° hooksï¼‰ã€‚è¯·å°½å¿«å®Œæˆ GitHub é…ç½®ã€‚

### ç®¡ç†å‘˜æƒé™
é…ç½®åˆ†æ”¯ä¿æŠ¤éœ€è¦ä»“åº“ç®¡ç†å‘˜æƒé™ã€‚å¦‚æœä½ ä¸æ˜¯ç®¡ç†å‘˜ï¼Œè¯·è”ç³»ä»“åº“æ‰€æœ‰è€…ã€‚

## ğŸ’¡ å¸¸è§é—®é¢˜

### Q: æˆ‘ç°åœ¨å°±åœ¨ dev åˆ†æ”¯ä¸Šï¼Œå¦‚ä½•å¼€å§‹å¼€å‘ï¼Ÿ

```bash
# åˆ›å»ºåŠŸèƒ½åˆ†æ”¯å³å¯
git checkout -b feature/your-feature-name
# ç°åœ¨å¯ä»¥è‡ªç”±æäº¤äº†
```

### Q: å¦‚ä½•è®©å…¶ä»–å›¢é˜Ÿæˆå‘˜ä¹Ÿé…ç½® hooksï¼Ÿ

è®©ä»–ä»¬æ‰§è¡Œï¼š
```bash
git pull origin dev
./scripts/setup-git-hooks.sh
```

### Q: å¦‚æœæˆ‘éœ€è¦ç´§æ€¥ä¿®å¤æ€ä¹ˆåŠï¼Ÿ

ä»ç„¶ä½¿ç”¨ PR æµç¨‹ï¼Œä½†å¯ä»¥ï¼š
- ä½¿ç”¨ `hotfix/*` åˆ†æ”¯
- è¯·æ±‚åŠ æ€¥å®¡æŸ¥
- ä½¿ç”¨ GitHub çš„ "urgent" æ ‡ç­¾

### Q: æˆ‘å¯ä»¥ç¦ç”¨ hooks å—ï¼Ÿ

å¯ä»¥ï¼Œä½†ä¸æ¨èï¼š
```bash
git commit --no-verify -m "message"
```

**æ³¨æ„ï¼šè¿™ä¸ä¼šç»•è¿‡ GitHub çš„åˆ†æ”¯ä¿æŠ¤è§„åˆ™ï¼ˆé…ç½®åï¼‰ã€‚**

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨æ¸…å•

- [ ] åœ¨ GitHub ä¸Šé…ç½® `dev` åˆ†æ”¯ä¿æŠ¤è§„åˆ™
- [ ] åœ¨ GitHub ä¸Šé…ç½® `upstream-*` åˆ†æ”¯ä¿æŠ¤è§„åˆ™
- [ ] é€šçŸ¥æ‰€æœ‰å›¢é˜Ÿæˆå‘˜æ›´æ–°å’Œè®¾ç½®
- [ ] é…ç½® CI/CD å·¥ä½œæµï¼ˆå¯é€‰ï¼‰
- [ ] åˆ›å»ºç¬¬ä¸€ä¸ªåŠŸèƒ½åˆ†æ”¯å¹¶æµ‹è¯•å·¥ä½œæµ
- [ ] ä¸å›¢é˜Ÿä¸€èµ· review æ–‡æ¡£å’Œæµç¨‹

## ğŸ“ è·å–å¸®åŠ©

- æŸ¥çœ‹ `docs/TEAM_WORKFLOW.md` è·å–å®Œæ•´æ–‡æ¡£
- æŸ¥çœ‹ `.github/BRANCH_PROTECTION_GUIDE.md` è·å–é…ç½®å¸®åŠ©
- åœ¨å›¢é˜Ÿç¾¤ç»„è®¨è®ºé—®é¢˜
- è”ç³»ä»“åº“ç®¡ç†å‘˜

---

ğŸŠ æ­å–œï¼ä½ çš„ä»“åº“ç°åœ¨æœ‰äº†ä¸“ä¸šçš„åˆ†æ”¯ç®¡ç†ç­–ç•¥ï¼
