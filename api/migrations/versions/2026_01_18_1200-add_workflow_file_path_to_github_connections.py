"""add workflow_file_path to github_connections

Revision ID: b2c3d4e5f6a7
Revises: a1b2c3d4e5f6
Create Date: 2026-01-18 12:00:00.000000

"""
from alembic import op
import models as models
import sqlalchemy as sa


def _is_pg(conn):
    return conn.dialect.name == "postgresql"


# revision identifiers, used by Alembic.
revision = "b2c3d4e5f6a7"
down_revision = "a1b2c3d4e5f6"
branch_labels = None
depends_on = None


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    conn = op.get_bind()

    with op.batch_alter_table("github_connections", schema=None) as batch_op:
        if _is_pg(conn):
            batch_op.add_column(
                sa.Column("workflow_file_path", sa.String(length=500), nullable=False, server_default="workflow.json")
            )
        else:
            batch_op.add_column(
                sa.Column("workflow_file_path", sa.String(length=500), nullable=False, server_default="workflow.json")
            )
    
    # Update existing rows to have workflow_file_path based on app_id
    # For existing connections, set workflow_file_path to workflows/{app_id}.json if app_id exists, else workflow.json
    if _is_pg(conn):
        op.execute("""
            UPDATE github_connections 
            SET workflow_file_path = CASE 
                WHEN app_id IS NOT NULL THEN 'workflows/' || app_id::text || '.json'
                ELSE 'workflow.json'
            END
            WHERE workflow_file_path = 'workflow.json'
        """)
    else:
        # MySQL syntax
        op.execute("""
            UPDATE github_connections 
            SET workflow_file_path = CASE 
                WHEN app_id IS NOT NULL THEN CONCAT('workflows/', app_id, '.json')
                ELSE 'workflow.json'
            END
            WHERE workflow_file_path = 'workflow.json'
        """)

    # ### end Alembic commands ###


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    with op.batch_alter_table("github_connections", schema=None) as batch_op:
        batch_op.drop_column("workflow_file_path")
    # ### end Alembic commands ###

