"""empty message

Revision ID: b16d7178fd1d
Revises: 669ffd70119c
Create Date: 2025-11-13 16:13:00.665249

"""
from alembic import op
import models as models
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql,mysql

def _is_pg(conn):
    return conn.dialect.name == "postgresql"

# revision identifiers, used by Alembic.
revision = 'b16d7178fd1d'
down_revision = '669ffd70119c'
branch_labels = None
depends_on = None


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    conn = op.get_bind()
    if _is_pg(conn):
       with op.batch_alter_table('data_source_oauth_bindings', schema=None) as batch_op:
              batch_op.drop_index(batch_op.f('source_info_idx'), postgresql_using='gin')
              batch_op.alter_column('source_info',
                     existing_type=postgresql.JSONB(astext_type=sa.Text()),
                     type_=sa.JSON(),
                     existing_nullable=False)

       with op.batch_alter_table('datasets', schema=None) as batch_op:
              batch_op.drop_index(batch_op.f('retrieval_model_idx'), postgresql_using='gin')
              batch_op.alter_column('retrieval_model',
                     existing_type=postgresql.JSONB(astext_type=sa.Text()),
                     type_=sa.JSON(),
                     existing_nullable=True)
              batch_op.alter_column('icon_info',
                     existing_type=postgresql.JSONB(astext_type=sa.Text()),
                     type_=sa.JSON(),
                     existing_nullable=True)

       with op.batch_alter_table('datasource_oauth_params', schema=None) as batch_op:
              batch_op.alter_column('system_credentials',
                     existing_type=postgresql.JSONB(astext_type=sa.Text()),
                     type_=sa.JSON(),
                     existing_nullable=False)

       with op.batch_alter_table('datasource_oauth_tenant_params', schema=None) as batch_op:
              batch_op.alter_column('client_params',
                     existing_type=postgresql.JSONB(astext_type=sa.Text()),
                     type_=sa.JSON(),
                     existing_nullable=False)

       with op.batch_alter_table('datasource_providers', schema=None) as batch_op:
              batch_op.alter_column('provider',
                     existing_type=sa.VARCHAR(length=255),
                     type_=sa.String(length=128),
                     existing_nullable=False)
              batch_op.alter_column('encrypted_credentials',
                     existing_type=postgresql.JSONB(astext_type=sa.Text()),
                     type_=sa.JSON(),
                     existing_nullable=False)

       with op.batch_alter_table('documents', schema=None) as batch_op:
              batch_op.drop_index(batch_op.f('document_metadata_idx'), postgresql_using='gin')
              batch_op.alter_column('doc_metadata',
                     existing_type=postgresql.JSONB(astext_type=sa.Text()),
                     type_=sa.JSON(),
                     existing_nullable=True)

       with op.batch_alter_table('external_knowledge_bindings', schema=None) as batch_op:
              batch_op.alter_column('external_knowledge_id',
                     existing_type=sa.TEXT(),
                     type_=sa.String(length=512),
                     existing_nullable=False)

       with op.batch_alter_table('providers', schema=None) as batch_op:
              batch_op.alter_column('quota_used',
                     existing_type=sa.BIGINT(),
                     nullable=False)

       with op.batch_alter_table('tenant_plugin_auto_upgrade_strategies', schema=None) as batch_op:
              batch_op.alter_column('exclude_plugins',
                     existing_type=postgresql.ARRAY(sa.VARCHAR(length=255)),
                     type_=sa.JSON(),
                     existing_nullable=False,
                     postgresql_using='to_jsonb(exclude_plugins)::json') 
              
              batch_op.alter_column('include_plugins',
                     existing_type=postgresql.ARRAY(sa.VARCHAR(length=255)),
                     type_=sa.JSON(),
                     existing_nullable=False,
                     postgresql_using='to_jsonb(include_plugins)::json') 

       with op.batch_alter_table('tool_oauth_tenant_clients', schema=None) as batch_op:
              batch_op.alter_column('plugin_id',
                     existing_type=sa.VARCHAR(length=512),
                     type_=sa.String(length=255),
                     existing_nullable=False)

       with op.batch_alter_table('trigger_oauth_system_clients', schema=None) as batch_op:
              batch_op.alter_column('plugin_id',
                     existing_type=sa.VARCHAR(length=512),
                     type_=sa.String(length=255),
                     existing_nullable=False)
    else:
       with op.batch_alter_table('providers', schema=None) as batch_op:
              batch_op.alter_column('quota_used',
                     existing_type=mysql.BIGINT(),
                     nullable=False)

       with op.batch_alter_table('trigger_oauth_system_clients', schema=None) as batch_op:
              batch_op.alter_column('plugin_id',
                     existing_type=mysql.VARCHAR(length=512),
                     type_=sa.String(length=255),
                     existing_nullable=False)

       with op.batch_alter_table('workflows', schema=None) as batch_op:
              batch_op.alter_column('updated_at',
                     existing_type=mysql.TIMESTAMP(),
                     type_=sa.DateTime(),
                     existing_nullable=False)

    # ### end Alembic commands ###


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    conn = op.get_bind()
    if _is_pg(conn):
       with op.batch_alter_table('trigger_oauth_system_clients', schema=None) as batch_op:
              batch_op.alter_column('plugin_id',
                     existing_type=sa.String(length=255),
                     type_=sa.VARCHAR(length=512),
                     existing_nullable=False)

       with op.batch_alter_table('tool_oauth_tenant_clients', schema=None) as batch_op:
              batch_op.alter_column('plugin_id',
                     existing_type=sa.String(length=255),
                     type_=sa.VARCHAR(length=512),
                     existing_nullable=False)

       with op.batch_alter_table('tenant_plugin_auto_upgrade_strategies', schema=None) as batch_op:
              batch_op.alter_column('include_plugins',
                     existing_type=sa.JSON(),
                     type_=postgresql.ARRAY(sa.VARCHAR(length=255)),
                     existing_nullable=False)
              batch_op.alter_column('exclude_plugins',
                     existing_type=sa.JSON(),
                     type_=postgresql.ARRAY(sa.VARCHAR(length=255)),
                     existing_nullable=False)

       with op.batch_alter_table('providers', schema=None) as batch_op:
              batch_op.alter_column('quota_used',
                     existing_type=sa.BIGINT(),
                     nullable=True)

       with op.batch_alter_table('external_knowledge_bindings', schema=None) as batch_op:
              batch_op.alter_column('external_knowledge_id',
                     existing_type=sa.String(length=512),
                     type_=sa.TEXT(),
                     existing_nullable=False)

       with op.batch_alter_table('documents', schema=None) as batch_op:
              batch_op.alter_column('doc_metadata',
                     existing_type=sa.JSON(),
                     type_=postgresql.JSONB(astext_type=sa.Text()),
                     existing_nullable=True)
              batch_op.create_index(batch_op.f('document_metadata_idx'), ['doc_metadata'], unique=False, postgresql_using='gin')

       with op.batch_alter_table('datasource_providers', schema=None) as batch_op:
              batch_op.alter_column('encrypted_credentials',
                     existing_type=sa.JSON(),
                     type_=postgresql.JSONB(astext_type=sa.Text()),
                     existing_nullable=False)
              batch_op.alter_column('provider',
                     existing_type=sa.String(length=128),
                     type_=sa.VARCHAR(length=255),
                     existing_nullable=False)

       with op.batch_alter_table('datasource_oauth_tenant_params', schema=None) as batch_op:
              batch_op.alter_column('client_params',
                     existing_type=sa.JSON(),
                     type_=postgresql.JSONB(astext_type=sa.Text()),
                     existing_nullable=False)

       with op.batch_alter_table('datasource_oauth_params', schema=None) as batch_op:
              batch_op.alter_column('system_credentials',
                     existing_type=sa.JSON(),
                     type_=postgresql.JSONB(astext_type=sa.Text()),
                     existing_nullable=False)

       with op.batch_alter_table('datasets', schema=None) as batch_op:
              batch_op.alter_column('icon_info',
                     existing_type=sa.JSON(),
                     type_=postgresql.JSONB(astext_type=sa.Text()),
                     existing_nullable=True)
              batch_op.alter_column('retrieval_model',
                     existing_type=sa.JSON(),
                     type_=postgresql.JSONB(astext_type=sa.Text()),
                     existing_nullable=True)
              batch_op.create_index(batch_op.f('retrieval_model_idx'), ['retrieval_model'], unique=False, postgresql_using='gin')

       with op.batch_alter_table('data_source_oauth_bindings', schema=None) as batch_op:
              batch_op.alter_column('source_info',
                     existing_type=sa.JSON(),
                     type_=postgresql.JSONB(astext_type=sa.Text()),
                     existing_nullable=False)
              batch_op.create_index(batch_op.f('source_info_idx'), ['source_info'], unique=False, postgresql_using='gin')
    else:
       with op.batch_alter_table('workflows', schema=None) as batch_op:
              batch_op.alter_column('updated_at',
                     existing_type=sa.DateTime(),
                     type_=mysql.TIMESTAMP(),
                     existing_nullable=False)

       with op.batch_alter_table('trigger_oauth_system_clients', schema=None) as batch_op:
              batch_op.alter_column('plugin_id',
                     existing_type=sa.String(length=255),
                     type_=mysql.VARCHAR(length=512),
                     existing_nullable=False)

       with op.batch_alter_table('providers', schema=None) as batch_op:
              batch_op.alter_column('quota_used',
                     existing_type=mysql.BIGINT(),
                     nullable=True)

    # ### end Alembic commands ###
