## Purpose

`api/controllers/console/datasets/datasets_document.py` contains the console (authenticated) APIs for managing dataset documents (list/create/update/delete, processing controls, estimates, etc.).

## Storage model (uploaded files)

- For local file uploads into a knowledge base, the binary is stored via `extensions.ext_storage.storage` under the key:
  - `upload_files/<tenant_id>/<uuid>.<ext>`
- File metadata is stored in the `upload_files` table (`UploadFile` model), keyed by `UploadFile.id`.
- Dataset `Document` records reference the uploaded file via:
  - `Document.data_source_info.upload_file_id`

## Download endpoint

- `GET /datasets/<dataset_id>/documents/<document_id>/download`

  - Only supported when `Document.data_source_type == "upload_file"`.
  - Performs dataset permission + tenant checks via `DocumentResource.get_document(...)`.
  - Validates the referenced `UploadFile` exists for the same tenant.
  - Returns a signed URL generated by `core.file.helpers.get_signed_file_url(..., as_attachment=True)`.
  - Applies `cloud_edition_billing_rate_limit_check("knowledge")` to match other KB operations.
  - Response body is **only**: `{ "url": "<signed-url>" }`.

- `POST /datasets/<dataset_id>/documents/download-zip`

  - Accepts `{ "document_ids": ["..."] }` (upload-file only).
  - Returns `application/zip` as a single attachment download.
  - Rationale: browsers often block multiple automatic downloads; a ZIP avoids that limitation.
  - Applies `cloud_edition_billing_rate_limit_check("knowledge")`.
  - The attachment filename (`download_name`) is a random `.zip` value (client-visible only).
  - Uses batch queries to load documents and upload files before streaming the ZIP.

## Verification plan

- Upload a document from a local file into a dataset.
- Call the download endpoint and confirm it returns a signed URL.
- Open the URL and confirm:
  - Response headers force download (`Content-Disposition`), and
  - Downloaded bytes match the uploaded file.
- Select multiple uploaded-file documents and download as ZIP; confirm all selected files exist in the archive.

## Shared helper

- `_get_upload_file_id_for_upload_file_document(...)` normalizes the upload file id and enforces source checks.
- `_get_upload_file_for_upload_file_document(document)` centralizes the “Document → UploadFile” lookup.
- `_get_upload_files_by_document_id_for_zip_download(...)` batches lookups and returns a
  `document_id -> UploadFile` map for ZIP downloads.
- ZIP packing is handled by `FileService.build_upload_files_zip_tempfile(...)`, which also:
  - sanitizes entry names to avoid path traversal, and
  - deduplicates names while preserving extensions (e.g., `doc.txt` → `doc (1).txt`).
  Streaming the response and deferring cleanup is handled by the route via `send_file(...)` + `ExitStack` +
  `response.call_on_close(...)`.
