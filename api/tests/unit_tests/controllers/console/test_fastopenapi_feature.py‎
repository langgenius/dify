import builtins
import sys
from unittest.mock import Mock, patch
import pytest
from flask import Flask
from flask.views import MethodView

from extensions import ext_fastopenapi
from models.engine import db

if not hasattr(builtins, "MethodView"):
    builtins.MethodView = MethodView

@pytest.fixture
def app(monkeypatch) -> Flask:
    monkeypatch.setattr("controllers.console.wraps.dify_config.EDITION", "CLOUD")
    
    def empty_decorator(f):
        return f

    monkeypatch.setattr("controllers.console.feature.setup_required", empty_decorator)
    monkeypatch.setattr("controllers.console.feature.login_required", empty_decorator)
    monkeypatch.setattr("controllers.console.feature.account_initialization_required", empty_decorator)
    monkeypatch.setattr("controllers.console.feature.cloud_utm_record", empty_decorator)
    
    app = Flask(__name__)
    app.config["TESTING"] = True
    app.config["SQLALCHEMY_DATABASE_URI"] = "sqlite:///:memory:"
    app.config["SQLALCHEMY_TRACK_MODIFICATIONS"] = False
    
    db.init_app(app)
    ext_fastopenapi.init_app(app)

    with app.app_context():
        try:
            from controllers.fastopenapi import console_router
            # 也可以在这里 import models 触发 SQLAlchemy 映射
        except ImportError:
            pytest.fail("无法导入 Controller，请检查路径")

        bp = getattr(console_router, "blueprint", getattr(console_router, "_blueprint", None))
        if bp:
            app.register_blueprint(bp, url_prefix="/console/api")
        else:
            if hasattr(console_router, "_routes"):
                for route in console_router._routes:
                    path = route.path.replace("{", "<").replace("}", ">")
                    endpoint_name = f"{route.endpoint.__module__}.{route.endpoint.__name__}"
                    app.add_url_rule(
                        f"/console/api{path}",
                        endpoint=endpoint_name,
                        view_func=route.endpoint,
                        methods=list(route.methods),
                    )
        
        db.create_all()
        
        yield app
        
        db.drop_all()


def test_console_features_fastopenapi_get(app: Flask):
    
    mock_resp = Mock()
    mock_resp.model_dump.return_value = {"enabled": True}

    with (
        patch("controllers.console.feature.current_account_with_tenant", return_value=(object(), "tenant-id")),
        patch("controllers.console.feature.FeatureService.get_features", return_value=mock_resp),
    ):
        client = app.test_client()
        response = client.get("/console/api/features")

    if response.status_code != 200:
        print(f"Error: {response.status_code}, Body: {response.get_data(as_text=True)}")

    assert response.status_code == 200
    assert response.get_json() == {"features": {"enabled": True}}


def test_console_system_features_fastopenapi_get(app: Flask):
    mock_resp = Mock()
    mock_resp.model_dump.return_value = {"system": True}

    with patch(
        "controllers.console.feature.FeatureService.get_system_features",
        return_value=mock_resp,
    ):
        client = app.test_client()
        response = client.get("/console/api/system-features")

    assert response.status_code == 200
    assert response.get_json() == {"features": {"system": True}}
