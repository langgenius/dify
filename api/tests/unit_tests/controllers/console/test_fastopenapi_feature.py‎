import sys
import pytest
from unittest.mock import MagicMock, patch
from flask import Flask
from extensions import ext_fastopenapi

class MockPydanticModel:
    def __init__(self, data):
        self.data = data

    def model_dump(self, **kwargs):
        return self.data

    def dict(self, **kwargs):  
        return self.data

@pytest.fixture
def app():
    app = Flask(__name__)
    app.config["TESTING"] = True
    app.config["SECRET_KEY"] = "test-secret"  
    return app

@pytest.fixture(autouse=True)
def fix_method_view_issue(monkeypatch):
    import builtins
    from flask.views import MethodView
    
    if not hasattr(builtins, "MethodView"):
        monkeypatch.setattr(builtins, "MethodView", MethodView, raising=False)

def test_console_features_fastopenapi_get(app: Flask, monkeypatch: pytest.MonkeyPatch):

    noop_decorator = lambda f: f

    if "controllers.console.feature" in sys.modules:
        del sys.modules["controllers.console.feature"]
    
    with patch("controllers.console.feature.setup_required", side_effect=noop_decorator), \
         patch("controllers.console.feature.login_required", side_effect=noop_decorator), \
         patch("controllers.console.feature.account_initialization_required", side_effect=noop_decorator), \
         patch("controllers.console.feature.cloud_utm_record", side_effect=noop_decorator), \
         patch("controllers.console.feature.current_account_with_tenant", return_value=(MagicMock(), "tenant-id")), \
         patch("controllers.console.feature.FeatureService.get_features", return_value=MockPydanticModel({"enabled": True})):
        
        ext_fastopenapi.init_app(app)
        
        client = app.test_client()
        response = client.get("/console/api/features")

    assert response.status_code == 200
    assert response.get_json() == {"features": {"enabled": True}}


def test_console_system_features_fastopenapi_get(app: Flask):
    if "controllers.console.feature" in sys.modules:
        del sys.modules["controllers.console.feature"]

    with patch("controllers.console.feature.FeatureService.get_system_features", return_value=MockPydanticModel({"system": True})):
        ext_fastopenapi.init_app(app)

        client = app.test_client()
        response = client.get("/console/api/system-features")

    assert response.status_code == 200
    assert response.get_json() == {"features": {"system": True}}
