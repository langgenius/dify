# Standalone PostgreSQL and Redis for Dify
# 独立部署 PostgreSQL 和 Redis 中间件
#
# 启动命令:
#   docker compose -f docker-compose.middleware.yaml --profile postgresql up -d
#
# 或者不使用 profile (同时启动 PostgreSQL 和 Redis):
#   docker compose -f docker-compose.middleware.yaml up -d
#
# 停止命令:
#   docker compose -f docker-compose.middleware.yaml down
#
# 配置说明:
#   创建 .env 文件或设置环境变量来自定义配置:
#   - DB_USERNAME: PostgreSQL 用户名 (默认: postgres)
#   - DB_PASSWORD: PostgreSQL 密码 (默认: difyai123456)
#   - DB_DATABASE: 数据库名称 (默认: dify)
#   - DB_PORT: PostgreSQL 端口 (默认: 5432)
#   - REDIS_PASSWORD: Redis 密码 (默认: difyai123456)
#   - REDIS_PORT: Redis 端口 (默认: 6379)

services:
  # PostgreSQL Database
  db_postgres:
    image: postgres:15-alpine
    container_name: dify-db-postgres
    ports:
      - "${DB_PORT:-5432}:5432"
    profiles:
      - postgresql
      - all
    restart: always
    environment:
      POSTGRES_USER: ${DB_USERNAME:-postgres}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-difyai123456}
      POSTGRES_DB: ${DB_DATABASE:-dify}
      PGDATA: ${PGDATA:-/var/lib/postgresql/data/pgdata}
    command: >
      postgres -c 'max_connections=${POSTGRES_MAX_CONNECTIONS:-100}'
               -c 'shared_buffers=${POSTGRES_SHARED_BUFFERS:-128MB}'
               -c 'work_mem=${POSTGRES_WORK_MEM:-4MB}'
               -c 'maintenance_work_mem=${POSTGRES_MAINTENANCE_WORK_MEM:-64MB}'
               -c 'effective_cache_size=${POSTGRES_EFFECTIVE_CACHE_SIZE:-512MB}'
               -c 'wal_buffers=${POSTGRES_WAL_BUFFERS:-4MB}'
               -c 'idle_in_transaction_session_timeout=${POSTGRES_IDLE_IN_TRANSACTION_SESSION_TIMEOUT:-0}'
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USERNAME:-postgres} -d ${DB_DATABASE:-dify}"]
      interval: 5s
      timeout: 5s
      retries: 30
    networks:
      - dify-middleware

  # Redis Cache
  redis:
    image: redis:6-alpine
    container_name: dify-redis
    ports:
      - "${REDIS_PORT:-6379}:6379"
    profiles:
      - redis
      - all
    restart: always
    environment:
      REDISCLI_AUTH: ${REDIS_PASSWORD:-difyai123456}
    volumes:
      - redis_data:/data
    command: redis-server --requirepass ${REDIS_PASSWORD:-difyai123456} --appendonly yes
    healthcheck:
      test: ["CMD-SHELL", "redis-cli -a ${REDIS_PASSWORD:-difyai123456} ping | grep -q PONG"]
      interval: 5s
      timeout: 5s
      retries: 30
    networks:
      - dify-middleware

networks:
  dify-middleware:
    name: dify-middleware
    driver: bridge

volumes:
  postgres_data:
    name: dify-postgres-data
  redis_data:
    name: dify-redis-data
